<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Marketplace</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
</head>
<body>
    <h1>Service Marketplace</h1>
    <p>Seller: <span id="sellerAddress"></span></p>
    <p>Price: <span id="price"></span> ETH</p>
    <p>Your Address: <span id="userAddress"></span></p>
    <button onclick="connectMetaMask()">Connect MetaMask</button>
    <button onclick="pay()">Pay</button>
    <button onclick="sendFile()">Send File</button>
    <button onclick="releaseFunds()">Release Funds</button>
    <div>
        <input type="file" id="fileInput">
    </div>
    <div id="output"></div>
    <script>
        let accounts;

        // Установка Web3.js с использованием MetaMask
        async function connectMetaMask() {
            if (window.ethereum) {
                window.web3 = new Web3(ethereum);
                try {
                    accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                    alert("MetaMask connected!");
                    document.getElementById("userAddress").innerText = accounts[0];
                } catch (error) {
                    console.error("User denied account access");
                }
            } else {
                console.log('Non-Ethereum browser detected. You should consider trying MetaMask!');
            }
        }

        // Адрес и ABI контракта
        const contractAddress = '0x8daC953ac14A6ffCb50736c6c908736FDc5C785E'; // Замените на адрес вашего контракта
        const contractABI = [
            {
                "inputs": [],
                "name": "pay",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "releaseFunds",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "sendFile",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "_buyer",
                        "type": "address"
                    }
                ],
                "name": "setBuyer",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_price",
                        "type": "uint256"
                    }
                ],
                "name": "setPrice",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "inputs": [],
                "name": "buyer",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "fileSent",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "price",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "seller",
                "outputs": [
                    {
                        "internalType": "address payable",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];
        const contract = new web3.eth.Contract(contractABI, contractAddress);

        // Получение информации о контракте
        async function loadContractInfo() {
            const sellerAddress = await contract.methods.seller().call();
            const price = await contract.methods.price().call();
            document.getElementById("sellerAddress").innerText = sellerAddress;
            document.getElementById("price").innerText = price;
        }

        // Функция отправки транзакции из MetaMask кошелька
        async function sendTransaction(method, ...args) {
            try {
                const result = await method.send({ from: accounts[0] });
                return result.transactionHash;
            } catch (error) {
                console.error('Transaction error:', error);
                return null;
            }
        }

        // Функция ожидания ответа транзакции
        async function waitForTransaction(transactionHash) {
            const receipt = await web3.eth.getTransactionReceipt(transactionHash);
            return receipt !== null;
        }

        // Функция вывода сообщения о результате транзакции
        function showMessage(message) {
            document.getElementById("output").innerText = message;
        }

        // Функция оплаты услуги
        async function pay() {
            const price = await contract.methods.price().call();
            const transactionHash = await sendTransaction(contract.methods.pay(), { value: price });
            if (transactionHash !== null) {
                const success = await waitForTransaction(transactionHash);
                if (success) {
                    showMessage("Payment successful!");
                } else {
                    showMessage("Payment failed.");
                }
            }
        }

        // Функция отправки файла
        async function sendFile() {
            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0];
            if (!file) {
                alert("Please select a file.");
                return;
            }

            const formData = new FormData();
            formData.append("file", file);

            try {
                const response = await fetch("your_file_upload_endpoint", {
                    method: "POST",
                    body: formData,
                });
                if (response.ok) {
                    const transactionHash = await sendTransaction(contract.methods.sendFile());
                    if (transactionHash !== null) {
                        const success = await waitForTransaction(transactionHash);
                        if (success) {
                            showMessage("File sent successfully!");
                        } else {
                            showMessage("Sending file failed.");
                        }
                    }
                } else {
                    showMessage("Error uploading file.");
                }
            } catch (error) {
                console.error("Error:", error);
            }
        }

        // Функция освобождения средств
        async function releaseFunds() {
            const transactionHash = await sendTransaction(contract.methods.releaseFunds());
            if (transactionHash !== null) {
                const success = await waitForTransaction(transactionHash);
                if (success) {
                    showMessage("Funds released successfully!");
                } else {
                    showMessage("Releasing funds failed.");
                }
            }
        }

        // Загрузка информации о контракте при загрузке страницы
        loadContractInfo();
    </script>
</body>
</html>
